name: build

on:
  #push:
  #  branches:
  #    - master
  #schedule:
  #  - cron: '0 */4 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/minetaro12/archlinux:latest
    steps:
      #- name: Checkout
        #uses: actions/checkout@v2

      - name: Build
        run: |
          cd ~

          sudo pacman -Syu --noconfirm
          git clone https://aur.archlinux.org/mozc-ut.git
          cd mozc-ut
          echo "ver=$(cat PKGBUILD | grep pkgver | cut -d "=" -f 2)" >> $GITHUB_ENV
          makepkg -s --noconfirm
          sudo pacman -U mozc-ut-*.pkg.tar.zst --noconfirm
          mv mozc-ut-*.pkg.tar.zst ../
          cd ..
          
          git clone https://aur.archlinux.org/fcitx5-mozc-ut.git
          cd fcitx5-mozc-ut
          makepkg -s --noconfirm
          mv fcitx5-mozc-ut-*.pkg.tar.zst ../
          cd ..
          
          repo-add mozc-ut-bin.db.tar.gz *.pkg.tar.zst
          
      - name: Release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          automatic_release_tag: ${{ env.ver }}
          prerelease: false
          files: |
              /home/user/mozc-ut-*.pkg.tar.zst
              /home/user/fcitx5-mozc-ut-*.pkg.tar.zst
              /home/user/mozc-ut-bin.db*
              /home/user/mozc-ut-bin.files*
